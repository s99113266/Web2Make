<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å“¡é é¢ - æ–‡ç« ç®¡ç†</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .admin-header {
            background-color: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 30px;
        }
        .admin-header h2 {
            margin: 0;
            font-size: 18px;
        }
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .action-btn {
            background-color: #2ecc71;
            color: white;
            text-align: center;
            padding: 12px 24px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: bold;
            transition: background-color 0.2s;
            min-width: 150px;
        }
        .action-btn:hover {
            background-color: #27ae60;
        }
        .action-btn.secondary {
            background-color: #3498db;
        }
        .action-btn.secondary:hover {
            background-color: #2980b9;
        }
        .article-list {
            list-style: none;
            padding: 0;
        }
        .article-item {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .article-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .article-title {
            font-size: 20px;
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        .article-date {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 10px;
            display: block;
        }
        .article-excerpt {
            color: #555;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        .article-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .article-link {
            display: inline-block;
            color: #3498db;
            text-decoration: none;
            font-weight: bold;
            padding: 5px 10px;
            border: 1px solid #3498db;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .article-link:hover {
            background-color: #3498db;
            color: white;
        }
        .edit-link {
            color: #f39c12;
            border-color: #f39c12;
        }
        .edit-link:hover {
            background-color: #f39c12;
            color: white;
        }
        .delete-link {
            color: #e74c3c;
            border-color: #e74c3c;
        }
        .delete-link:hover {
            background-color: #e74c3c;
            color: white;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #7f8c8d;
        }
        .no-articles {
            text-align: center;
            padding: 40px 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .error-message {
            background-color: #f2dede;
            color: #a94442;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
        }
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        .page-btn, .page-num {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background-color: #fff;
            color: #333;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            font-size: 14px;
        }
        .page-btn:hover, .page-num:hover {
            background-color: #f8f9fa;
            border-color: #3498db;
        }
        .page-btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
            background-color: #f8f9fa;
        }
        .page-num.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        .page-info {
            text-align: center;
            color: #7f8c8d;
            font-size: 14px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <h2>ğŸ”§ ç®¡ç†å“¡æ§åˆ¶å°</h2>
        <p>æ­¡è¿ä½¿ç”¨æ–‡ç« ç®¡ç†ç³»çµ±</p>
    </div>
    
    <h1>æ–‡ç« ç®¡ç†</h1>
    
    <div class="action-buttons">
        <a href="add-article.html" class="action-btn">ğŸ“ æ–°å¢æ–‡ç« </a>
        <a href="../index.html" class="action-btn secondary">ğŸ‘ï¸ æŸ¥çœ‹å‰å°</a>
    </div>
    
    <div id="articleContainer">
        <div class="loading">è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div>
    </div>
    
    <div id="paginationContainer" style="display: none;">
        <div class="pagination">
            <button class="page-btn" id="prevBtn" onclick="goToPage(currentPage - 1)">â† ä¸Šä¸€é </button>
            <span id="pageNumbers"></span>
            <button class="page-btn" id="nextBtn" onclick="goToPage(currentPage + 1)">ä¸‹ä¸€é  â†’</button>
        </div>
        <div class="page-info" id="pageInfo"></div>
    </div>

    <script>
        let currentPage = 1;
        let configUrl = null;
        let paginationData = null;

        document.addEventListener('DOMContentLoaded', function() {
            // å¾URLåƒæ•¸ç²å–é æ•¸
            const urlParams = new URLSearchParams(window.location.search);
            const pageParam = urlParams.get('page');
            if (pageParam && parseInt(pageParam) > 0) {
                currentPage = parseInt(pageParam);
            }

            // å¾é…ç½®æ–‡ä»¶ç²å–URL
            fetch('../config.json')
                .then(response => response.json())
                .then(config => {
                    configUrl = config.Url;
                    fetchArticles(config.Url, currentPage);
                })
                .catch(error => {
                    showError('ç„¡æ³•è®€å–é…ç½®æ–‡ä»¶ï¼š' + error.message);
                });
        });

        function fetchArticles(url, page = 1) {
            currentPage = page;
            
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            const container = document.getElementById('articleContainer');
            container.innerHTML = '<div class="loading">è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div>';
            document.getElementById('paginationContainer').style.display = 'none';
            
            // å‰µå»ºXMLHttpRequestå°è±¡
            const xhr = new XMLHttpRequest();
            xhr.open('POST', url, true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            
            xhr.onload = function() {
                if (xhr.status >= 200 && xhr.status < 300) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        displayArticles(response);
                    } catch (error) {
                        showError('è§£æè¿”å›æ•¸æ“šæ™‚å‡ºéŒ¯ï¼š' + error.message);
                    }
                } else {
                    showError('è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼ï¼š' + xhr.status);
                }
            };
            
            xhr.onerror = function() {
                showError('ç™¼ç”Ÿç¶²è·¯éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é€£æ¥');
            };
            
            // ç™¼é€è«‹æ±‚ï¼Œåƒæ•¸ç‚ºpage=åˆ—è¡¨ï¼ŒpageNumå’ŒpageSize
            const params = `page=åˆ—è¡¨&pageNum=${page}&pageSize=10`;
            xhr.send(params);
        }

        function displayArticles(response) {
            const container = document.getElementById('articleContainer');
            container.innerHTML = '';
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æ•¸æ“š
            if (response.state === 1) {
                container.innerHTML = '<div class="no-articles">ç›®å‰æ²’æœ‰ä»»ä½•æ–‡ç« </div>';
                document.getElementById('paginationContainer').style.display = 'none';
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æ–‡ç« æ•¸æ“š
            if (!response.data || !Array.isArray(response.data) || response.data.length === 0) {
                container.innerHTML = '<div class="no-articles">ç›®å‰æ²’æœ‰ä»»ä½•æ–‡ç« </div>';
                document.getElementById('paginationContainer').style.display = 'none';
                return;
            }
            
            // å‰µå»ºæ–‡ç« åˆ—è¡¨
            const articleList = document.createElement('ul');
            articleList.className = 'article-list';
            
            response.data.forEach(article => {
                const articleItem = document.createElement('li');
                articleItem.className = 'article-item';
                
                articleItem.innerHTML = `
                    <h2 class="article-title">${escapeHTML(article.title)}</h2>
                    <span class="article-date">${escapeHTML(article.date)}</span>
                    <p class="article-excerpt">${escapeHTML(article.excerpt)}</p>
                    <div class="article-actions">
                        <a href="../view-article.html?id=${article.id}" class="article-link" target="_blank">ğŸ‘ï¸ é è¦½</a>
                        <a href="edit-article.html?id=${article.id}" class="article-link edit-link">âœï¸ ç·¨è¼¯</a>
                        <a href="#" class="article-link delete-link" data-article-id="${article.id}" data-article-title="${escapeHTML(article.title)}">ğŸ—‘ï¸ åˆªé™¤</a>
                    </div>
                `;
                
                // ç‚ºåˆªé™¤æŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½å™¨
                const deleteBtn = articleItem.querySelector('.delete-link');
                deleteBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const articleId = this.getAttribute('data-article-id');
                    const articleTitle = this.getAttribute('data-article-title');
                    deleteArticle(articleId, articleTitle, articleItem);
                });
                
                articleList.appendChild(articleItem);
            });
            
            container.appendChild(articleList);
            
            // è™•ç†åˆ†é ä¿¡æ¯
            if (response.pagination) {
                // è‡ªå‹•è¨ˆç®—åˆ†é è³‡è¨Š
                const pagination = response.pagination;
                pagination.currentPage = currentPage;  // ä½¿ç”¨å‰ç«¯çš„ç•¶å‰é æ•¸
                pagination.totalPages = Math.ceil(pagination.totalCount / pagination.pageSize);
                pagination.hasNext = pagination.currentPage < pagination.totalPages;
                pagination.hasPrev = pagination.currentPage > 1;
                
                paginationData = pagination;
                renderPagination();
                updatePageInfo();
                document.getElementById('paginationContainer').style.display = 'block';
            } else {
                // å¦‚æœæ²’æœ‰åˆ†é ä¿¡æ¯ï¼Œéš±è—åˆ†é çµ„ä»¶
                document.getElementById('paginationContainer').style.display = 'none';
            }
        }

        function deleteArticle(articleId, articleTitle, articleElement) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤æ–‡ç« ã€Œ${articleTitle}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                // è©¢å•ç®¡ç†å“¡å¯†ç¢¼
                const password = prompt('è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š');
                if (!password) {
                    return; // ä½¿ç”¨è€…å–æ¶ˆè¼¸å…¥
                }
                
                // é¡¯ç¤ºåˆªé™¤ä¸­ç‹€æ…‹
                const deleteBtn = articleElement.querySelector('.delete-link');
                const originalText = deleteBtn.innerHTML;
                deleteBtn.innerHTML = 'â³ åˆªé™¤ä¸­...';
                deleteBtn.style.pointerEvents = 'none';
                
                // å¾é…ç½®æ–‡ä»¶ç²å–URL
                fetch('../config.json')
                    .then(response => response.json())
                    .then(config => {
                        // ä½¿ç”¨AJAXç™¼é€åˆªé™¤è«‹æ±‚
                        const xhr = new XMLHttpRequest();
                        xhr.open('POST', config.Url, true);
                        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                        
                        xhr.onload = function() {
                            if (xhr.status >= 200 && xhr.status < 300) {
                                try {
                                    const response = JSON.parse(xhr.responseText);
                                    if (response.state === 0) {
                                        // æˆåŠŸåˆªé™¤ï¼Œå…ˆæ·»åŠ æ·¡å‡ºå‹•ç•«
                                        articleElement.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
                                        articleElement.style.opacity = '0';
                                        articleElement.style.transform = 'translateX(-100%)';
                                        
                                        // 500ms å¾Œç§»é™¤å…ƒç´ ä¸¦é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                                        setTimeout(() => {
                                            articleElement.remove();
                                            
                                            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                                            const successMsg = document.createElement('div');
                                            successMsg.style.cssText = `
                                                position: fixed;
                                                top: 20px;
                                                right: 20px;
                                                background-color: #2ecc71;
                                                color: white;
                                                padding: 15px 20px;
                                                border-radius: 5px;
                                                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                                                z-index: 1000;
                                                font-weight: bold;
                                            `;
                                            successMsg.textContent = 'âœ… æ–‡ç« åˆªé™¤æˆåŠŸï¼';
                                            document.body.appendChild(successMsg);
                                            
                                            // 3ç§’å¾Œç§»é™¤æˆåŠŸè¨Šæ¯
                                            setTimeout(() => {
                                                successMsg.style.transition = 'opacity 0.3s ease-out';
                                                successMsg.style.opacity = '0';
                                                setTimeout(() => successMsg.remove(), 300);
                                            }, 3000);
                                            
                                            // æª¢æŸ¥æ˜¯å¦é‚„æœ‰æ–‡ç« ï¼Œæ²’æœ‰å‰‡é¡¯ç¤ºç©ºç‹€æ…‹
                                            const remainingArticles = document.querySelectorAll('.article-item');
                                            if (remainingArticles.length === 0) {
                                                const container = document.getElementById('articleContainer');
                                                container.innerHTML = '<div class="no-articles">ç›®å‰æ²’æœ‰ä»»ä½•æ–‡ç« </div>';
                                            }
                                        }, 500);
                                    } else {
                                        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                                        deleteBtn.innerHTML = originalText;
                                        deleteBtn.style.pointerEvents = 'auto';
                                        alert('åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç®¡ç†å“¡å¯†ç¢¼æˆ–ç¨å¾Œå†è©¦ã€‚');
                                    }
                                } catch (error) {
                                    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                                    deleteBtn.innerHTML = originalText;
                                    deleteBtn.style.pointerEvents = 'auto';
                                    alert('ä¼ºæœå™¨å›æ‡‰æ ¼å¼éŒ¯èª¤ï¼š' + error.message);
                                }
                            } else {
                                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                                deleteBtn.innerHTML = originalText;
                                deleteBtn.style.pointerEvents = 'auto';
                                alert('åˆªé™¤å¤±æ•—ï¼Œç‹€æ…‹ç¢¼ï¼š' + xhr.status);
                            }
                        };
                        
                        xhr.onerror = function() {
                            // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                            deleteBtn.innerHTML = originalText;
                            deleteBtn.style.pointerEvents = 'auto';
                            alert('ç™¼ç”Ÿç¶²è·¯éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é€£æ¥ã€‚');
                        };
                        
                        // ç™¼é€è«‹æ±‚ï¼Œåƒæ•¸ç‚ºpage=åˆªé™¤ã€idå’Œpwd
                        const params = `page=åˆªé™¤&id=${encodeURIComponent(articleId)}&pwd=${encodeURIComponent(password)}`;
                        xhr.send(params);
                    })
                    .catch(error => {
                        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                        deleteBtn.innerHTML = originalText;
                        deleteBtn.style.pointerEvents = 'auto';
                        alert('ç„¡æ³•è®€å–é…ç½®æ–‡ä»¶ï¼š' + error.message);
                    });
            }
        }

        function goToPage(page) {
            if (page < 1 || (paginationData && page > paginationData.totalPages)) {
                return;
            }
            
            // æ›´æ–°URLåƒæ•¸
            const url = new URL(window.location);
            url.searchParams.set('page', page);
            window.history.pushState({}, '', url);
            
            // ç²å–æ–‡ç« 
            fetchArticles(configUrl, page);
            
            // æ»¾å‹•åˆ°é ‚éƒ¨
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderPagination() {
            if (!paginationData) return;
            
            const pageNumbers = document.getElementById('pageNumbers');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            // æ›´æ–°ä¸Šä¸€é /ä¸‹ä¸€é æŒ‰éˆ•
            prevBtn.disabled = !paginationData.hasPrev;
            nextBtn.disabled = !paginationData.hasNext;
            
            // ç”Ÿæˆé ç¢¼æŒ‰éˆ•
            pageNumbers.innerHTML = '';
            
            const totalPages = paginationData.totalPages;
            const current = paginationData.currentPage;
            
            // è¨ˆç®—é¡¯ç¤ºç¯„åœ
            let startPage = Math.max(1, current - 2);
            let endPage = Math.min(totalPages, current + 2);
            
            // å¦‚æœç¸½é æ•¸å°‘æ–¼5é ï¼Œé¡¯ç¤ºæ‰€æœ‰é æ•¸
            if (totalPages <= 5) {
                startPage = 1;
                endPage = totalPages;
            }
            
            // ç¬¬ä¸€é 
            if (startPage > 1) {
                const firstBtn = document.createElement('button');
                firstBtn.className = 'page-num';
                firstBtn.textContent = '1';
                firstBtn.onclick = () => goToPage(1);
                pageNumbers.appendChild(firstBtn);
                
                if (startPage > 2) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    dots.style.padding = '8px 4px';
                    pageNumbers.appendChild(dots);
                }
            }
            
            // ä¸­é–“é ç¢¼
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-num ${i === current ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => goToPage(i);
                pageNumbers.appendChild(pageBtn);
            }
            
            // æœ€å¾Œä¸€é 
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    dots.style.padding = '8px 4px';
                    pageNumbers.appendChild(dots);
                }
                
                const lastBtn = document.createElement('button');
                lastBtn.className = 'page-num';
                lastBtn.textContent = totalPages;
                lastBtn.onclick = () => goToPage(totalPages);
                pageNumbers.appendChild(lastBtn);
            }
        }

        function updatePageInfo() {
            if (!paginationData) return;
            
            const pageInfo = document.getElementById('pageInfo');
            pageInfo.textContent = `ç¬¬ ${paginationData.currentPage} é ï¼Œå…± ${paginationData.totalPages} é ï¼ˆç¸½å…± ${paginationData.totalCount} ç¯‡æ–‡ç« ï¼‰`;
        }

        function showError(message) {
            const container = document.getElementById('articleContainer');
            container.innerHTML = `<div class="error-message">${message}</div>`;
            document.getElementById('paginationContainer').style.display = 'none';
        }

        // ç”¨æ–¼é˜²æ­¢XSSæ”»æ“Šçš„HTMLè½‰ç¾©å‡½æ•¸
        function escapeHTML(str) {
            if (!str) return '';
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
    </script>
</body>
</html> 